<% layout("/layouts/boilerplate") %>
  <div class="row mt-3">
    <div class="col-8 offset-2">
      <br>
      <h1>Edit Listing</h1>

      <form method="POST" id="listing-form" action="/listings/<%= listing._id %>?_method=PUT" class="needs-validation"
        enctype="multipart/form-data" novalidate>
        <div class="mb-3 mt-4">
          <label for="title" class="form-label"><h3>Title</h3></label>
          <input name="listing[title]" value="<%= listing.title %>" type="text" class="form-control"
            placeholder="Enter title" required />
          <div class="invalid-feedback">Title is required.</div>
        </div>

        <div class="mb-3 mt-4">
          <label for="description" class="form-label"><h3>Description</h3></label>
          <textarea name="listing[description]" class="form-control" placeholder="Enter description"
            required><%= listing.description %></textarea>
          <div class="invalid-feedback">Description is required.</div>
        </div>

        <div class="mb-3 mt-4">
          <h3>Original Listing Image</h3>
          <br>
          <img class="show-img" src="<%= listing.image.url %>" alt="listing_image">
        </div>

        <div class="mb-3 mt-4">
          <label for="image" class="form-label"><h3>Upload Image</h3></label>
          <input name="listing[image]" value="<%= listing.image %>" type="file" class="form-control" />
        </div>
        <div class="mb-3 mt-4" id="category-group">
          <label class="form-label"><h3>Choose Categories</h3></label>
          <div class="row">
            <% categories.forEach(cat=> { %>
              <div class="col-md-3 col-sm-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="listing[category][]" value="<%= cat %>"
                    id="cat-<%= cat.replace(/\s+/g, '-') %>" <%=listing.category && listing.category.includes(cat)
                    ? "checked" : "" %>
                  >
                  <label class="form-check-label" for="cat-<%= cat.replace(/\s+/g, '-') %>">
                    <%= cat %>
                  </label>
                </div>
              </div>
              <% }) %>
          </div>
          <div class="invalid-feedback">Please select at least one category.</div>
        </div>
        <% const listingAmenities=listing.amenities ? Object.fromEntries(listing.amenities) : {} %>

          <div class="mb-3 mt-4" id="amenities-group">
            <label class="form-label"><h3>Select Amenities</h3></label>

            <% for (const [section, items] of Object.entries(amenities)) { %>
              <h6 class="mt-2">
                <%= section %>
              </h6>
              <div class="row">
                <% items.forEach(item=> { %>
                  <div class="col-md-3 col-sm-6">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="listing[amenities][<%= section %>][]"
                        value="<%= item %>" id="amenity-<%= item.replace(/\s+/g, '-') %>" <%=listingAmenities[section]
                        && listingAmenities[section].includes(item) ? "checked" : "" %>
                      >
                      <label class="form-check-label" for="amenity-<%= item.replace(/\s+/g, '-') %>">
                        <%= item %>
                      </label>
                    </div>
                  </div>
                  <% }) %>
              </div>
              <% } %>
          </div>



          <div class="row mt-4">
            <div class="mb-3 col-md-4">
              <label for="price" class="form-label"><h3>Price</h3></label>
              <input name="listing[price]" value="<%= listing.price %>" type="number" class="form-control"
                placeholder="Enter price" required />
              <div class="invalid-feedback">Price is required.</div>
            </div>

            <div class="mb-3 col-md-8">
              <label for="location" class="form-label"><h3>Location</h3></label>
              <input name="listing[location]" value="<%= listing.location %>" type="text" class="form-control"
                placeholder="Enter location" required />
              <div class="invalid-feedback">Location is required.</div>
            </div>
          </div>

          <div class="mb-3 mt-4">
            <label for="country" class="form-label"><h3>Country</h3></label>
            <input name="listing[country]" value="<%= listing.country %>" type="text" class="form-control"
              placeholder="Enter country" required />
            <div class="invalid-feedback">Country is required.</div>
          </div>

          <button class="btn btn-dark update-btn mt-3">Update</button>
      </form>
    </div>
  </div>